<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project1.backend_spring.mapper.UserMapper">

    <insert id="insertUser" parameterType="com.project1.backend_spring.dto.UserDTO" useGeneratedKeys="true" keyProperty="historyId">
        INSERT INTO user (user_name, email, login_social_id, safety_portal_id, safety_portal_pw) 
        VALUES (#{userName}, #{email}, #{loginSocialId}, #{safetyPortalId}, #{safetyPortalPw})
    </insert>

    <select id="findBySocialId" resultType="com.project1.backend_spring.dto.UserDTO">
        SELECT history_id AS historyId, user_name AS userName, email, login_social_id AS loginSocialId 
        FROM user WHERE login_social_id = #{loginSocialId}
    </select>

    <select id="findAllUsers" resultType="com.project1.backend_spring.dto.UserDTO">
        SELECT history_id AS historyId, user_name AS userName, email FROM user
    </select>

    <select id="findUserById" resultType="com.project1.backend_spring.dto.UserDTO">
        SELECT history_id AS historyId, user_name AS userName, email FROM user WHERE history_id = #{historyId}
    </select>

    <insert id="insertDevice" parameterType="com.project1.backend_spring.dto.DeviceDTO">
        INSERT INTO Device (serial_no, history_id) VALUES (#{serialNo}, #{historyId})
    </insert>

    <select id="findDevicesByUserId" resultType="com.project1.backend_spring.dto.DeviceDTO">
        SELECT serial_no AS serialNo, history_id AS historyId 
        FROM Device WHERE history_id = #{historyId}
    </select>

    <select id="findUserBySerialNo" resultType="Integer">
        SELECT history_id FROM Device WHERE serial_no = #{serialNo} LIMIT 1
    </select>

    <insert id="insertIncidentLog" parameterType="com.project1.backend_spring.dto.IncidentLogDTO">
        INSERT INTO incident_log (
            serial_no, video_url, incident_date, incident_time, 
            violation_type, plate_no, AI_draft, location
        ) VALUES (
            #{serialNo}, #{videoUrl}, #{incidentDate}, #{incidentTime}, 
            #{violationType}, #{plateNo}, #{aiDraft}, #{location}
        )
    </insert>

    <select id="getLastInsertId" resultType="int"> SELECT LAST_INSERT_ID() </select>

    <insert id="insertReport">
        INSERT INTO report (history_id, incident_log, description, is_submitted) 
        VALUES (#{userId}, #{logId}, #{aiDraft}, 0)
    </insert>

    <select id="findReportsByUserId" resultType="com.project1.backend_spring.dto.ReportDTO">
        SELECT 
            r.report_id AS reportId,
            r.history_id AS historyId,
            r.incident_log AS incidentLog,
            r.is_submitted AS isSubmitted,
            r.description AS description,
            r.phone_number AS phoneNumber,   
            r.is_agreed AS isAgreed,         
            l.serial_no AS serialNo,
            l.incident_date AS incidentDate,
            l.incident_time AS incidentTime,
            l.video_url AS videoUrl,
            l.violation_type AS violationType, 
            l.plate_no AS plateNo,
            l.AI_draft AS aiDraft,
            l.location AS location
        FROM report r
        JOIN incident_log l ON r.incident_log = l.incident_log
        WHERE r.history_id = #{userId}
          AND r.is_deleted = 0  ORDER BY r.report_id DESC
    </select>

    <select id="findVideoUrlByReportId" resultType="String">
        SELECT l.video_url 
        FROM report r 
        JOIN incident_log l ON r.incident_log = l.incident_log
        WHERE r.report_id = #{reportId}
    </select>

    <update id="deleteReport">
        UPDATE report 
        SET is_deleted = 1 
        WHERE report_id = #{reportId}
    </update>

    <update id="submitReport" parameterType="com.project1.backend_spring.dto.ReportDTO">
        UPDATE report r
        INNER JOIN incident_log l ON r.incident_log = l.incident_log
        SET 
            r.is_submitted = 0,                 r.phone_number = #{phoneNumber},    r.description = #{description}, 
            r.is_agreed = #{isAgreed},          l.violation_type = #{violationType},
            l.plate_no = #{plateNo},
            l.location = #{location},
            l.incident_date = #{incidentDate},
            l.incident_time = #{incidentTime}
        WHERE r.report_id = #{reportId}
    </update>

    <delete id="deleteReportByUserId"> DELETE FROM report WHERE history_id = #{historyId} </delete>
    <delete id="deleteIncidentLogByUserId"> 
        DELETE FROM incident_log 
        WHERE serial_no IN (SELECT serial_no FROM Device WHERE history_id = #{historyId}) 
    </delete>
    <delete id="deleteDeviceByUserId"> DELETE FROM Device WHERE history_id = #{historyId} </delete>
    <delete id="deleteUser"> DELETE FROM user WHERE history_id = #{historyId} </delete>

    <!-- 안전신문고 id 중복 검사 -->
    <select id="checkPortalIdDuplicate" resultType="int">
        SELECT COUNT(*) 
        FROM user 
        WHERE safety_portal_id = #{portalId}
          AND history_id != #{historyId}  </select>

    <!-- 유저 테이블 안전신문고 계정 정보 업데이트 -->
    <update id="updatePortalInfo">
        UPDATE user
        SET 
            safety_portal_id = #{portalId},
            safety_portal_pw = #{portalPw}
        WHERE history_id = #{historyId}
    </update>
    
    <select id="getAutoReportData" resultType="com.project1.backend_spring.dto.AutoReportRequestDTO">
        SELECT 
            u.safety_portal_id AS portalId,    
            u.safety_portal_pw AS portalPw,    
            r.phone_number     AS userPhone,   
            u.user_name        AS userName,
            
            il.violation_type  AS title,       
            r.description      AS content,     
            il.plate_no        AS carNum,     
            il.video_url       AS videoUrl,
        
            il.location        AS location,    
            
            DATE_FORMAT(il.incident_date, '%Y-%m-%d') AS occurDate,
            DATE_FORMAT(il.incident_time, '%H')       AS occurTimeHh,
            DATE_FORMAT(il.incident_time, '%i')       AS occurTimeMm
            
        FROM report r
        JOIN user u ON r.history_id = u.history_id
        JOIN incident_log il ON r.incident_log = il.incident_log
        WHERE r.report_id = #{reportId}
    </select>

</mapper>